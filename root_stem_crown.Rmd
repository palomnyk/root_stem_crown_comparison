---
title: "root_stem_crown_comparison"
output: html_notebook
author: 'Aaron Yerke'
---

This the R Notebook for collaboration with Dr. Yogini Jaiswal for her comparison of roots, stems, and crowns.

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

From Yogini:
I. Changes done in all files and annotations
* In all the files refer to the sheet: “Combined stem and roots” and “For PCA – Stem and Roots”
* All cells in pink indicate that the constituent is not present in the sample
* I believe in the previous study, we used “zeros” in rows where samples were not present.
* All values present in “Combined stem and roots” are normalised with internal standard area for GC-MS File.
* The data generated for analytes represent relative rather than absolute concentrations (semi-quantitative) based on their areas. All values generated for these compounds are therefore “unitless” but strongly correlate to absolute concentration when comparing values for the same metabolite; however, this does not apply when comparing values between different metabos.
* For LC-MS analysis there are two files, negative and positive representing 2 different modes of ionisation used for analysis to have a more comprehensive identification of compounds that can be detected/ionised in both positive and negative mode. 
* There can be compounds that may be common between both ‘positive’ and ‘negative’ mode of LC-MS analysis files. 

II. Nomenclature:
A. Crown root parts: 
CRP: Crown root peel. 
CNP: Crown root with ‘no’ peel
CWO: Whole crown root
B.  Lateral root parts: 
LRP: whole lateral root
C.  Stem parts: 
SWP: Whole stem. 
SNP: Stem with ‘no’ peel
SP: Stem peel

III.  Suggested comparisons 
1. Whole crown root / lateral root/ stem
2. Each part of Crown root and lateral root. 
3. Each part of Crown root

IV. Changes done in files for PCA analysis:

File 1: NCAT155_GCMS_7July2017 (1)
1. Refer to the sheet: “Combined stem and roots” and “For PCA – Stem and Roots”. 
2. Removed the internal standard row - “Docosanoic acid, methyl ester (IS)”, as it is an internal standard used for quality control and not a constituent. 
3. Removed putative annotations for “present” and “not present”

File 2: NCAT155-Negative mode - LC-MS
1. Refer to the sheet: “Combined stem and roots” and “For PCA – Stem and Roots”. 
2. In this file, all samples marked in green, are the same constituent but different mass adducts. 
    So I have discarded them in the sheet “For PCA – Stem and Roots”.  

File 3: NCAT155-Positive mode- LC-MS-SORTED- Roots
1. Refer to the sheet: “Combined stem and roots” and “For PCA – Stem and Roots”. 
2. In this file, all samples marked in green, are the same constituent but different mass adducts. 
    So I have discarded them in the sheet “For PCA – Stem and Roots”.  
3. For compounds with two adducts, the adduct rows with lower areas are deleted (will check with you before deletion)


First work with GC Data:
```{r}
rm(list = ls()) #clear workspace

#read in meta-data
meta_data = read.table(file.path('.','gc_data','meta_data.csv'), 
  sep=",", 
  header=TRUE, 
  row.names = 1, 
  check.names = FALSE,
  stringsAsFactors=FALSE)

#meta_data = read.csv(file.path('.','gc_data','meta_data.csv'),row.names=1, stringsAsFactors=FALSE)

#read in raw numeric data
metabolites = read.table(file.path('.','gc_data','gc_data_numeric.csv'), 
  sep=",", 
  header=TRUE, 
  row.names = 1, 
  check.names = FALSE)


#function to replace NA with 0 #on second thought, don't do this.
# is.nan.data.frame = function(x){
#   do.call(cbind, lapply(x, is.nan))
# }
# 
# #remove zeros
# metabolites[is.na(metabolites)] <- 0

#boxplot before transform
boxplot(metabolites, 
        main = 'GC Data without log-transform',
        col = as.factor(meta_data['plant_part',])
        )

metabolites = log2(metabolites + 1)

#create levels
l = gl(7, 3,
  labels = c('CRP', 'CNP', 'CWO', 'LRP', 'SWP', 'SNP', 'SP'))

#colors for boxplot
myColors = c(rep("red",3),rep("blue",3),rep("green",3),rep('yellow', 3), rep('lightblue',3), rep('violet',3), rep('grey', 3))

boxplot(metabolites,
  main = 'GC Data with log-transform',
  col=l
)
par(new=TRUE)
stripchart(metabolites,
  method='jitter',
  jitter=.2,
  vertical=TRUE,
  add=T,
  pch=16,
  cex = 0.6,
  col = 'grey')
plot.new()
legend('bottomright', legend = unique(l), col = unique(l), pch = 1, cex=0.6)
```
This tells me that we need to use the log transform. Visually, only SWP seems to be radically different.

Next look at PCA.
```{r}
#create PCA
group_pca = prcomp(t(na.omit(metabolites)), 
  center = TRUE,
  scale = TRUE)

#extract PCA matrix and convert to dataframe
myPCA = data.frame(group_pca$x)

summary(group_pca)
```
PCA1 and PCA2 account for 84% cummaltively.


PCA1 and PCA2
```{r}
for (i in 1:nrow(meta_data)){
  print(i)
  plot(myPCA$PC1, myPCA$PC2,
    col=as.factor(meta_data[i,]),
    main = paste('Catagory: ', row.names(meta_data)[i])
  )
  legend('bottomright', legend = unique(as.factor(meta_data[i,])),
    col = unique(as.factor(unique(meta_data[i,]))),
    pch = 1,
    cex=0.6
    )
}
```
PCA1 and PCA2 -> file for sending to collaborators
```{r}
pdf("gcPca1_2.pdf")
for (i in 1:nrow(meta_data)){
  plot(myPCA$PC1, myPCA$PC2,
    col=as.factor(meta_data[i,]),
    main = paste('Catagory: ', row.names(meta_data)[i])
  )
  legend('bottomright', legend = unique(as.factor(meta_data[i,])),
    col = unique(as.factor(unique(meta_data[i,]))),
    pch = 1,
    cex=0.6
    )
}
dev.off()
```

PCA1 and PCA3
```{r}
for (i in 1:nrow(meta_data)){
  print(i)
  plot(myPCA$PC1, myPCA$PC3,
    xlab = 'PCA1, 66% of Variance',
    ylab = 'PCA3, 3% of Variance',
    col=as.factor(meta_data[i,]),
    main = row.names(meta_data)[i]
    )
  legend('bottomright', legend = unique(as.factor(meta_data[i,])), 
    col = unique(as.factor(unique(meta_data[i,]))), 
    pch = 1, 
    cex=0.6)
}
```

PCA2 and PCA3
```{r}
for (i in 1:nrow(meta_data)){
  print(i)
  plot(myPCA$PC2, myPCA$PC3,
    col=as.factor(meta_data[i,]),
    main = row.names(meta_data)[i],
    xlab = 'PCA2, 17% of Variance',
    ylab = 'PCA3, 6% of Variance'
    )
  legend('bottomright', legend = unique(as.factor(meta_data[i,])), 
    col = unique(as.factor(unique(meta_data[i,]))),
    pch = 1,
    cex=0.6
  )
}
```


Compare each PCA to each metadata catagory using lm and anova.

Expected output: Table, 
  columns: PCAs, metadata catagory, pvals
```{r}
pcas = c()
metaNames = c()
metaPval = c()

for (i1 in 1:ncol(myPCA)){
  for (i2 in 1:nrow(meta_data)){
    myLm = lm( myPCA[,i1] ~ as.factor(as.character(meta_data[i2,])))
    pcas = c(pcas, i1)
    metaNames = c(metaNames, row.names(meta_data)[i2])
    metaPval =  c(metaPval, anova(myLm)$"Pr(>F)"[1])
  }
}

metaPvalAdj = p.adjust(metaPval, method = "BH")
dFrame <- data.frame(metaPvalAdj,metaNames,pcas)
dFrame <- dFrame [order(dFrame$metaPvalAdj),]

write.table(dFrame, file="gcMetaVsPCAs.txt", row.names=FALSE, sep="\t")

pdf("gcMetaVsPcas.pdf")
#par(mfrow=c(2,2))

for( i in 1:nrow(dFrame)){
	aTitle <- paste( 'PCA', dFrame$pcas[i], "vs",  dFrame$metaNames[i], "\nAdjusted Pvalue=",
	round(dFrame$metaPvalAdj[i], digits = 4))
	
	plot( as.factor(as.character(meta_data[as.character(dFrame$metaNames[i]),])), 
	  myPCA[,dFrame$pcas[i]],
	  main = aTitle,
	  xlab = as.character(dFrame$metaNames[i]), 
	  ylab = paste('PCA', as.character(dFrame$pcas[i]))
	  )
}

dev.off()
```


Compare each metabolite to each metadata.
  Expected output:
    Table: 
      Columns: adjusted pval (sorted), metadata name, metabolite name
```{r}
metabos = c()
metaNames = c()
metaPval = c()

for (i1 in 1:nrow(metabolites)){
  for (i2 in 1:nrow(meta_data)){
    myLm = lm( unlist(metabolites[i1,]) ~ as.factor(as.character(meta_data[i2,])))
    metabos = c(metabos, row.names(metabolites)[i1])
    metaNames = c(metaNames, row.names(meta_data)[i2])
    metaPval =  c(metaPval, anova(myLm)$"Pr(>F)"[1])
  }
}

metaPvalAdj = p.adjust(metaPval, method = "BH")

dFrame <- data.frame(metaPvalAdj,metaNames,metabos)
dFrame <- dFrame [order(dFrame$metaPvalAdj),]

write.table(dFrame, file="gcMetaVsMetabolites.txt", row.names=FALSE, sep="\t")

pdf("gcMetaVsMetabolites.pdf")
#par(mfrow=c(2,2))

for( i in 1:nrow(dFrame)){
	aTitle <- paste(  dFrame$metabos[i], "vs",  dFrame$metaNames[i], "\nAdjusted Pvalue=",
	round(dFrame$metaPvalAdj[i], digits = 4))
	
	plot( as.factor(as.character(meta_data[as.character(dFrame$metaNames[i]),])), 
	  unlist(metabolites[as.character(dFrame$metabos[i]),]),
	  main = aTitle,
	  xlab = as.character(dFrame$metaNames[i]), 
	  ylab = as.character(dFrame$metabos[i])
	  )
}

dev.off()

```

```{r}
pdf("gcNaRowsDroppedPcas.pdf")
palette("default")
plot(myPcaNa$PC1, myPcaNa$PC2,
  xlab = 'PCA1, 66% of Variance',
  ylab = 'PCA2, 17% of Variance',
  main = 'PCA with NA omitted, log tranformed',
  col=l
)
legend('topright', legend = unique(l), 
  col = unique(l), 
  pch = 1, 
  cex=0.6
)
dev.off()
```
```{r}
function(){
  
}
```


```{r}
for (i in 1:nrow(meta_data)){
  print(i)
  plot(myPcaNa$PC1, myPcaNa$PC2,
    col=as.factor(meta_data[i,]),
    main = row.names(meta_data)[i]
  )
  legend('topright', legend = unique(as.factor(meta_data[i,])),
    col = unique(as.factor(unique(meta_data[i,]))),
    pch = 1,
    cex=0.6
    )
}
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
